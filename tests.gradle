/* Supporting tasks for backend tests */
String containerName = "backendContainer"
String tempDirPath = "${rootDir}/src/test/resources/tmp"

dockerRun {
    name = containerName
    image 'jqpoon/arm_compile_emulate:working'
    arguments '-t', '-v', tempDirPath + ':/compile/src:ro'
}

tasks.dockerRun.doFirst {
    mkdir tempDirPath
}

task dockerStopAndRemove(type: Exec) {
    commandLine 'docker', 'stop', '-t', '1', containerName
    delete tempDirPath
    finalizedBy(dockerRemoveContainer)
}

/* Frontend tests */
test {
    systemProperties = [tempDirPath: tempDirPath, containerName: containerName]
    useJUnitPlatform()
}

task frontendValidTest(type: Test) {
    useJUnitPlatform {
        includeTags 'valid'
    }
    testLogging {
        events "PASSED", "SKIPPED", "FAILED"
    }
}

task frontendInvalidSyntaxTest(type: Test) {
    useJUnitPlatform {
        includeTags 'invalid'
    }
    testLogging {
        events "PASSED", "SKIPPED", "FAILED"
    }
}

/* Backend tests */
task backendTest(type: Test) {
    systemProperties = [tempDirPath: tempDirPath, containerName: containerName]
    useJUnitPlatform {
        includeTags 'backend'
    }
    dependsOn(tasks.dockerRun)
    finalizedBy(dockerStopAndRemove)
}
